name: Persistent Ubuntu VPS (SSHX + 1s Autosave + Heartbeat + Cron Restart)

on:
  schedule:
    - cron: "30 5 * * *"  # every day at 05:30 UTC (adjust timezone)
  workflow_dispatch:       # allow manual start

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6 hours
    env:
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Prepare vm_data folder
        run: |
          mkdir -p $GITHUB_WORKSPACE/vm_data

      - name: Restore previous VM data (direct copy)
        run: |
          cd $GITHUB_WORKSPACE
          mkdir -p vm_data
          git clone --branch vm-data https://$PAT_TOKEN@github.com/${{ github.repository }} temp-vm-data
          cp -r temp-vm-data/* vm_data/
          cp -r temp-vm-data/.* vm_data/ 2>/dev/null || true
          rm -rf temp-vm-data
          echo "✅ All files restored from vm-data branch."

      - name: Install and start SSHX in background
        run: |
          cd $GITHUB_WORKSPACE/vm_data
          nohup bash -c "curl -sSf https://sshx.io/get | sh -s run > $GITHUB_WORKSPACE/vm_data/sshx_link.txt 2>&1" &
          sleep 10
          echo "🌐 SSHX Link:"
          grep -Eo 'https://sshx.io/[^ ]+' $GITHUB_WORKSPACE/vm_data/sshx_link.txt || echo "❌ SSHX link not found"

      - name: Start heartbeat & 1-second autosave
        run: |
          cd $GITHUB_WORKSPACE/vm_data
          nohup bash -c "while true; do
            # Heartbeat log
            echo \"[\$(date '+%Y-%m-%d %H:%M:%S')] ✅ VPS alive (autosave running)\" >> status.log

            # Git autosave
            git init -q
            git config user.email 'actions@github.com'
            git config user.name 'github-actions'
            git add .
            git commit -m \"🕐 Autosave at \$(date)\" -q || true
            git branch -M vm-data
            git push -f https://$PAT_TOKEN@github.com/${{ github.repository }} vm-data >/dev/null 2>&1 || true

            sleep 1
          done" &
          echo "✅ Heartbeat & autosave running in background."

      - name: Keep VPS alive for 5 hours 30 minutes
        run: |
          echo "🕔 VPS running for 5 hours 30 minutes..."
          sleep $((5*3600 + 30*60))
          echo "⏹ VPS sleep ended — workflow will exit now."

      - name: Final save before workflow ends
        if: always()
        run: |
          cd $GITHUB_WORKSPACE/vm_data
          git init -q
          git config user.email 'actions@github.com'
          git config user.name 'github-actions'
          git add .
          git commit -m "💾 Final autosave before workflow exit $(date)" -q || true
          git branch -M vm-data
          git push -f https://$PAT_TOKEN@github.com/${{ github.repository }} vm-data || true
          echo "✅ Final data saved."
