name: Single-Run Persistent Ubuntu VPS (SSHX + 1s Autosave + Heartbeat)

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # Max GitHub allows (~6 hours)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Restore previous VM data
        run: |
          echo "ðŸ” Restoring /home/runner/vm_data from vm-data branch..."
          mkdir -p /home/runner/vm_data
          git fetch origin vm-data || echo "âš ï¸ No vm-data branch found, starting fresh."
          git checkout origin/vm-data -- /home/runner/vm_data 2>/dev/null || true
          echo "âœ… Data restored."

      - name: Install SSHX
        run: |
          echo "âš™ï¸ Installing SSHX..."
          curl -fsSL https://sshx.io/get | sh
          echo "âœ… SSHX installed."

      - name: Start SSHX VPS + Heartbeat
        run: |
          echo "ðŸš€ Starting Ubuntu VPS..."
          cd /home/runner/vm_data
          # Start heartbeat log
          nohup bash -c 'while true; do echo "[$(date '+%Y-%m-%d %H:%M:%S')] âœ… VPS alive (autosave running)" >> status.log; sleep 1; done' &
          # Start VPS
          sshx run > sshx_link.txt 2>&1 &
          sleep 10
          echo "ðŸŒ SSHX Link (open in browser):"
          grep -Eo 'https://sshx.io/[^ ]+' sshx_link.txt || echo "âŒ SSHX link not found"
          echo "âœ… VPS is running!"

      - name: Continuous Autosave
        run: |
          echo "ðŸ’¾ Starting autosave loop..."
          cd /home/runner/vm_data
          while true; do
            git init -q
            git config user.email "actions@github.com"
            git config user.name "github-actions"
            git add .
            git commit -m "ðŸ• Autosave at $(date)" -q || true
            git branch -M vm-data
            git push -f https://github.com/${{ github.repository }} vm-data >/dev/null 2>&1 || true
            sleep 1
          done

      - name: Final Save Before Runner Shutdown
        if: always()
        run: |
          echo "ðŸ“¦ GitHub runner is shutting down â€” saving final VM data..."
          cd /home/runner/vm_data
          git init -q
          git config user.email "actions@github.com"
          git config user.name "github-actions"
          git add .
          git commit -m "ðŸ’¾ Final autosave before shutdown $(date)" -q || true
          git branch -M vm-data
          git push -f https://github.com/${{ github.repository }} vm-data || true
          echo "âœ… Data saved before termination."
